name: GitHub Copilot License Management

# Limit the default GITHUB_TOKEN permissions to the minimum required
permissions:
  contents: read
  issues: write
  actions: read

# This workflow is triggered when an issue is labeled
on:
  issues:
    types:
      - labeled

# This workflow uses the GitHub Token to comment on the issues and close them
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# This workflow contains two jobs: assign_github_copilot_license and remove_github_copilot_license
jobs:
  assign_github_copilot_license:
    name: Assign GitHub Copilot License
    runs-on: ubuntu-latest
    if: github.event.label.name == 'copilot-request'
    steps:
      # This step gets a GitHub App installation access token
      - name: Get Token
        id: get_workflow_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APPLICATION_ID }}
          private-key: ${{ secrets.APPLICATION_PRIVATE_KEY }}

      # This step tries to assign a license and handles specific errors
      - name: Assign GitHub Copilot license
        id: assign_license
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.get_workflow_token.outputs.token }}
          result-encoding: string
          script: |
            try {
              await github.request('POST /orgs/{org}/copilot/billing/selected_users', {
                org: context.repo.owner,
                selected_usernames: [context.payload.sender.login],
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              return 'success';
            } catch (error) {
              if (error.status === 422 && error.message.includes('User already has Copilot access')) {
                console.log('User already has a license.');
                return 'already_exists';
              }
              console.error('Failed to assign license:', error);
              return 'failure';
            }

      # This step runs if the user ALREADY has a license
      - name: Comment on existing license and close issue
        if: steps.assign_license.outputs.result == 'already_exists'
        uses: actions/github-script@v7
        with:
          script: |
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'It appears you already have an active GitHub Copilot license. No action was needed. Closing this request. âœ…',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });
            await github.request('PATCH /repos/{owner}/{repo}/issues/{issue_number}', {
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

      # This step runs on successful assignment
      - name: Comment and close GitHub Issue on success
        if: steps.assign_license.outputs.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Successfully assigned the GitHub Copilot license. <br> <br> Here are some resources to help you get started with GitHub Copilot: <br><ul><li><a href="https://learn.microsoft.com/training/paths/copilot">GitHub Copilot Fundamentals MS Learn Path</a></li><li><a href="https://resources.github.com/learn/pathways/copilot/essentials/essentials-of-github-copilot">Essentials of GitHub Copilot</a></li><li><a href="https://www.youtube.com/playlist?list=PLlrxD0HtieHgr23PS05FIncnih4dH9Na5">Introduction to GitHub Copilot</a></li><li><a href="https://github.com/microsoft/Mastering-GitHub-Copilot-for-Paired-Programming">Mastering GitHub Copilot for AI Paired Programming</a></li></ul>',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });
            await github.request('PATCH /repos/{owner}/{repo}/issues/{issue_number}', {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

      # This step runs on any other failure
      - name: Comment GitHub Issue on failure
        if: steps.assign_license.outputs.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Failed assigning the GitHub Copilot license. Please contact the organization administrator.',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

  remove_github_copilot_license:
    name: Remove GitHub Copilot License
    runs-on: ubuntu-latest
    if: github.event.label.name == 'copilot-remove'
    steps:
      - name: Get Token
        id: get_workflow_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APPLICATION_ID }}
          private-key: ${{ secrets.APPLICATION_PRIVATE_KEY }}

      - name: Remove GitHub Copilot license
        id: remove_license
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.get_workflow_token.outputs.token }}
          result-encoding: string
          script: |
            try {
              await github.request('DELETE /orgs/{org}/copilot/billing/selected_users', {
                org: context.repo.owner,
                selected_usernames: [context.payload.sender.login],
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              return 'success';
            } catch (error) {
              console.error('Failed to remove license:', error);
              return 'failure';
            }

      - name: Comment and close GitHub Issue on success
        if: steps.remove_license.outputs.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Successfully removed the GitHub Copilot license.',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });
            await github.request('PATCH /repos/{owner}/{repo}/issues/{issue_number}', {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });

      - name: Comment GitHub Issue on failure
        if: steps.remove_license.outputs.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            await github.request('POST /repos/{owner}/{repo}/issues/{issue_number}/comments', {
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'Failed removing the GitHub Copilot license. Please contact the organization administrator.',
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            });